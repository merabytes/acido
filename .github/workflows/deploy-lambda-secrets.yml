name: Deploy Secrets Lambda to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  ECR_REPOSITORY: acido-secrets
  LAMBDA_FUNCTION_NAME: AcidoSecrets

jobs:
  deploy:
    name: Build and Deploy Secrets Lambda
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for AWS OIDC authentication
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        IMAGE_TAG: ${{ github.sha }}
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      run: |
        # Build the Docker image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile.lambda.secrets .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Push the images to ECR
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Output the image URI for next steps
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Update Lambda function with new image
      run: |
        aws lambda update-function-code \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --image-uri ${{ steps.build-image.outputs.image }}

    - name: Wait for Lambda update to complete
      run: |
        echo "Waiting for Lambda function update to complete..."
        aws lambda wait function-updated \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
        echo "Lambda function update completed successfully"

    - name: Update Lambda environment variables
      run: |
        # Build environment variables JSON
        ENV_VARS="KEY_VAULT_NAME=${{ secrets.KEY_VAULT_NAME }},AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }},AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }},AZURE_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}"
        
        # Add optional CF_SECRET_KEY if set
        if [ -n "${{ secrets.CF_SECRET_KEY }}" ]; then
          ENV_VARS="${ENV_VARS},CF_SECRET_KEY=${{ secrets.CF_SECRET_KEY }}"
          echo "CloudFlare Turnstile bot protection enabled"
        else
          echo "CloudFlare Turnstile bot protection not configured (optional)"
        fi
        
        aws lambda update-function-configuration \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --environment "Variables={${ENV_VARS}}"

    - name: Wait for environment update to complete
      run: |
        echo "Waiting for Lambda environment update to complete..."
        aws lambda wait function-updated \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
        echo "Lambda environment update completed successfully"

    - name: Get Lambda function info
      run: |
        echo "Lambda function deployment completed!"
        aws lambda get-function \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --query 'Configuration.[FunctionName,LastModified,State,ImageUri]' \
          --output table

    - name: Test Secrets Lambda Function
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      env:
        SECRETS_FUNCTION_LAMBDA_URL: ${{ secrets.SECRETS_FUNCTION_LAMBDA_URL }}
      run: |
        if [ -n "$SECRETS_FUNCTION_LAMBDA_URL" ]; then
          echo "=========================================="
          echo "Testing deployed Secrets Lambda Function"
          echo "=========================================="
          
          # Test 1: Create a secret
          echo ""
          echo "Test 1: Creating a secret..."
          create_response=$(curl -i -X POST "$SECRETS_FUNCTION_LAMBDA_URL" \
            -H "Content-Type: application/json" \
            -H 'User-Agent: Merabytes-Portal' \
            -d @example_lambda_secrets_create_payload.json \
            --max-time 30 \
            --silent \
            --write-out "\n%{http_code}")
          
          # Extract HTTP status code and body
          create_http_code=$(echo "$create_response" | tail -n1)
          create_body=$(echo "$create_response" | sed '$d')
          
          echo "HTTP Status Code: $create_http_code"
          echo "Response: $create_body"
          
          # Check if creation was successful (201)
          if [ "$create_http_code" -eq 201 ]; then
            echo "✓ Secret creation test PASSED"
            
            # Extract UUID from response
            if command -v jq &> /dev/null; then
              uuid=$(echo "$create_body" | grep -o '"uuid":"[^"]*"' | cut -d'"' -f4 | tail -n1)
              
              if [ -n "$uuid" ]; then
                echo "Generated UUID: $uuid"
                
                # Test 2: Retrieve the secret (should succeed once)
                echo ""
                echo "Test 2: Retrieving the secret (first time)..."
                retrieve_response=$(curl -i -X POST "$SECRETS_FUNCTION_LAMBDA_URL" \
                  -H "Content-Type: application/json" \
                  -H 'User-Agent: Merabytes-Portal' \
                  -d "{\"action\":\"retrieve\",\"uuid\":\"$uuid\"}" \
                  --max-time 30 \
                  --silent \
                  --write-out "\n%{http_code}")
                
                retrieve_http_code=$(echo "$retrieve_response" | tail -n1)
                retrieve_body=$(echo "$retrieve_response" | sed '$d')
                
                echo "HTTP Status Code: $retrieve_http_code"
                echo "Response: $retrieve_body"
                
                if [ "$retrieve_http_code" -eq 200 ]; then
                  echo "✓ Secret retrieval test PASSED"
                  
                  # Test 3: Try to retrieve again (should fail with 404)
                  echo ""
                  echo "Test 3: Attempting to retrieve the secret again (should fail)..."
                  retry_response=$(curl -i -X POST "$SECRETS_FUNCTION_LAMBDA_URL" \
                    -H "Content-Type: application/json" \
                    -H 'User-Agent: Merabytes-Portal' \
                    -d "{\"action\":\"retrieve\",\"uuid\":\"$uuid\"}" \
                    --max-time 30 \
                    --silent \
                    --write-out "\n%{http_code}")
                  
                  retry_http_code=$(echo "$retry_response" | tail -n1)
                  retry_body=$(echo "$retry_response" | sed '$d')
                  
                  echo "HTTP Status Code: $retry_http_code"
                  echo "Response: $retry_body"
                  
                  if [ "$retry_http_code" -eq 404 ]; then
                    echo "✓ One-time access test PASSED"
                    echo ""
                    echo "=========================================="
                    echo "✓ All Secrets Lambda tests PASSED"
                    echo "=========================================="
                  else
                    echo "✗ One-time access test FAILED"
                    echo "Expected HTTP 404, got $retry_http_code"
                    exit 1
                  fi
                else
                  echo "✗ Secret retrieval test FAILED"
                  echo "Expected HTTP 200, got $retrieve_http_code"
                  exit 1
                fi
              else
                echo "⚠ Could not extract UUID from response, skipping retrieval tests"
              fi
            else
              echo "⚠ jq not available, skipping retrieval tests"
            fi
          else
            echo "✗ Secret creation test FAILED"
            echo "Expected HTTP 201, got $create_http_code"
            exit 1
          fi
        else
          echo "⚠ SECRETS_FUNCTION_LAMBDA_URL secret not set, skipping test"
          echo "To enable testing, add SECRETS_FUNCTION_LAMBDA_URL to repository secrets"
        fi
