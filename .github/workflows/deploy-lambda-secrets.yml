name: Deploy Secrets Lambda to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  ECR_REPOSITORY: acido-secrets
  LAMBDA_FUNCTION_NAME: AcidoSecrets

jobs:
  deploy:
    name: Build and Deploy Secrets Lambda
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for AWS OIDC authentication
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        IMAGE_TAG: ${{ github.sha }}
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      run: |
        # Build the Docker image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile.lambda.secrets .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Push the images to ECR
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Output the image URI for next steps
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Update Lambda function with new image
      run: |
        aws lambda update-function-code \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --image-uri ${{ steps.build-image.outputs.image }}

    - name: Wait for Lambda update to complete
      run: |
        echo "Waiting for Lambda function update to complete..."
        aws lambda wait function-updated \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
        echo "Lambda function update completed successfully"

    - name: Update Lambda environment variables
      run: |
        # Build environment variables JSON
        ENV_VARS="KEY_VAULT_NAME=${{ secrets.KEY_VAULT_NAME }},AZURE_TENANT_ID=${{ secrets.SECRETS_AZURE_TENANT_ID }},AZURE_CLIENT_ID=${{ secrets.SECRETS_AZURE_CLIENT_ID }},AZURE_CLIENT_SECRET=${{ secrets.SECRETS_AZURE_CLIENT_SECRET }}"
        
        # Add optional CF_SECRET_KEY if set
        if [ -n "${{ secrets.CF_SECRET_KEY }}" ]; then
          ENV_VARS="${ENV_VARS},CF_SECRET_KEY=${{ secrets.CF_SECRET_KEY }}"
          echo "CloudFlare Turnstile bot protection enabled"
        else
          echo "CloudFlare Turnstile bot protection not configured (optional)"
        fi
        
        # Add optional CORS_ORIGIN if set, defaults to https://secrets.merabytes.com
        if [ -n "${{ secrets.CORS_ORIGIN }}" ]; then
          ENV_VARS="${ENV_VARS},CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}"
          echo "CORS origin set to: ${{ secrets.CORS_ORIGIN }}"
        else
          ENV_VARS="${ENV_VARS},CORS_ORIGIN=https://secrets.merabytes.com"
          echo "CORS origin using default: https://secrets.merabytes.com"
        fi
        
        aws lambda update-function-configuration \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --environment "Variables={${ENV_VARS}}"

    - name: Wait for environment update to complete
      run: |
        echo "Waiting for Lambda environment update to complete..."
        aws lambda wait function-updated \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
        echo "Lambda environment update completed successfully"

    - name: Get Lambda function info
      run: |
        echo "Lambda function deployment completed!"
        aws lambda get-function \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --query 'Configuration.[FunctionName,LastModified,State,ImageUri]' \
          --output table

    - name: Test Secrets Lambda Function
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      env:
        SECRETS_FUNCTION_LAMBDA_URL: ${{ secrets.SECRETS_FUNCTION_LAMBDA_URL }}
        CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
      run: |
        if [ -n "$SECRETS_FUNCTION_LAMBDA_URL" ]; then
          echo "=========================================="
          echo "Testing deployed Secrets Lambda Function"
          echo "=========================================="
          
          # Use configured CORS origin or default
          ORIGIN_URL="${CORS_ORIGIN:-https://secrets.merabytes.com}"
          echo "Testing with CORS origin: $ORIGIN_URL"
          
          # Test healthcheck with CORS headers
          echo ""
          echo "Test: Healthcheck endpoint with CORS validation..."
          healthcheck_response=$(curl -i -X POST "$SECRETS_FUNCTION_LAMBDA_URL" \
            -H "Content-Type: application/json" \
            -H "Origin: $ORIGIN_URL" \
            -H 'User-Agent: Merabytes-Portal' \
            -d '{"action":"healthcheck"}' \
            --max-time 30 \
            --silent \
            --write-out "\n%{http_code}")
          
          # Extract HTTP status code and body
          healthcheck_http_code=$(echo "$healthcheck_response" | tail -n1)
          healthcheck_body=$(echo "$healthcheck_response" | sed '$d')
          
          echo "HTTP Status Code: $healthcheck_http_code"
          echo "Response Headers and Body:"
          echo "$healthcheck_body"
          
          # Check if healthcheck was successful (200)
          if [ "$healthcheck_http_code" -eq 200 ]; then
            echo "✓ Healthcheck test PASSED"
            
            # Verify CORS headers are present
            if echo "$healthcheck_body" | grep -q "Access-Control-Allow-Origin"; then
              echo "✓ CORS headers present"
            else
              echo "⚠ CORS headers not found in response"
            fi
            
            # Verify response body
            if echo "$healthcheck_body" | grep -q "healthy"; then
              echo "✓ Healthcheck response valid"
            else
              echo "⚠ Healthcheck response format unexpected"
            fi
            
            echo ""
            echo "=========================================="
            echo "✓ Secrets Lambda healthcheck test PASSED"
            echo "  - Lambda function is running"
            echo "  - CORS headers configured correctly"
            echo "  - Healthcheck endpoint working"
            echo "=========================================="
            echo ""
            echo "Note: Turnstile validation is now required for create/retrieve actions."
            echo "Full integration tests require valid Turnstile tokens and cannot be"
            echo "automated in CI. Use healthcheck for deployment verification."
          else
            echo "✗ Healthcheck test FAILED"
            echo "Expected HTTP 200, got $healthcheck_http_code"
            exit 1
          fi
        else
          echo "⚠ SECRETS_FUNCTION_LAMBDA_URL secret not set, skipping test"
          echo "To enable testing, add SECRETS_FUNCTION_LAMBDA_URL to repository secrets"
        fi
