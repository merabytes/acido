name: CI Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  # Azure credentials - required for full integration tests
  # These should be configured as repository secrets
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  IMAGE_REGISTRY_SERVER: ${{ secrets.IMAGE_REGISTRY_SERVER }}
  IMAGE_REGISTRY_USERNAME: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
  IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
  STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
  # Docker Hub credentials - used for pulling base images
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install .

    - name: Verify acido installation
      run: |
        python -c "from acido.utils.decoration import __version__; print('acido version:', __version__)"
        python -c "from acido.cli import parser; print('CLI parser loaded successfully')"

    - name: Test acido imports
      run: |
        python -c "from acido.azure_utils.BlobManager import BlobManager"
        python -c "from acido.azure_utils.InstanceManager import InstanceManager, Resources"
        python -c "from acido.azure_utils.NetworkManager import NetworkManager, NetworkProfile"
        python -c "from acido.azure_utils.VaultManager import VaultManager"
        python -c "from acido.azure_utils.ManagedIdentity import ManagedAuthentication"
        python -c "from acido.utils.functions import chunks, split_file"
        python -c "from acido.utils.shell_utils import wait_command, exec_command"

    - name: Test CLI help
      run: |
        python -m acido.cli --help
        python -m acido.cli create --help

    - name: Run Python syntax check
      run: |
        python -m py_compile acido/cli.py
        python -m py_compile acido/azure_utils/*.py
        python -m py_compile acido/utils/*.py

  build-test:
    name: Build and Install Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Build distribution
      run: |
        python -m pip install --upgrade pip setuptools wheel build
        python -m build

    - name: Install from wheel
      run: |
        pip install dist/*.whl

    - name: Verify installation
      run: |
        python -c "from acido.utils.decoration import __version__; print('Successfully installed acido version:', __version__)"
        python -m acido.cli --help

  acido-create-test:
    name: Test acido create nuclei
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install acido
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install .

    - name: Test acido create nuclei
      env:
        INSTANCE_NAME: test-acido-instance
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        IMAGE_REGISTRY_SERVER: ${{ secrets.IMAGE_REGISTRY_SERVER }}
        IMAGE_REGISTRY_USERNAME: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
        IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
        STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        # This will test that acido can create a nuclei image using the correct Docker image
        # It will use environment variables for configuration
        acido create nuclei --image projectdiscovery/nuclei:latest || echo "Note: Image creation may fail without proper credentials, but command should execute"

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint

    - name: Run flake8
      continue-on-error: true
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 acido --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 acido --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Check code structure
      run: |
        # Verify all Python files are valid
        find acido -name "*.py" -exec python -m py_compile {} \;
