name: CI Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  # Azure credentials - required for full integration tests
  # These should be configured as repository secrets
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  IMAGE_REGISTRY_SERVER: ${{ secrets.IMAGE_REGISTRY_SERVER }}
  IMAGE_REGISTRY_USERNAME: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
  IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
  STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
  STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
  MANAGED_IDENTITY_ID: ${{ secrets.MANAGED_IDENTITY_ID }}
  MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
  # Docker Hub credentials - used for pulling base images
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install .

    - name: Verify acido installation
      run: |
        python -c "from acido.utils.decoration import __version__; print('acido version:', __version__)"
        python -c "from acido.cli import parser; print('CLI parser loaded successfully')"

    - name: Check version consistency
      run: |
        DECORATION_VERSION=$(python -c "from acido.utils.decoration import __version__; print(__version__)")
        SETUP_VERSION=$(grep "version=" setup.py | cut -d"'" -f2)
        LAMBDA_VERSION=$(grep "'version':" lambda_handler_secrets.py | grep -o "'[0-9.]*'" | tr -d "'")
        echo "decoration.py version: $DECORATION_VERSION"
        echo "setup.py version: $SETUP_VERSION"
        echo "lambda_handler_secrets.py version: $LAMBDA_VERSION"
        if [ "$DECORATION_VERSION" != "$SETUP_VERSION" ]; then
          echo "::error::Version mismatch between decoration.py ($DECORATION_VERSION) and setup.py ($SETUP_VERSION)"
          exit 1
        fi
        if [ "$DECORATION_VERSION" != "$LAMBDA_VERSION" ]; then
          echo "::warning::Version mismatch between decoration.py ($DECORATION_VERSION) and lambda_handler_secrets.py ($LAMBDA_VERSION)"
        fi

    - name: Test acido imports
      run: |
        python -c "from acido.azure_utils.BlobManager import BlobManager"
        python -c "from acido.azure_utils.InstanceManager import InstanceManager"
        python -c "from acido.azure_utils.NetworkManager import NetworkManager, NetworkProfile"
        python -c "from acido.azure_utils.VaultManager import VaultManager"
        python -c "from acido.azure_utils.ManagedIdentity import ManagedIdentity"
        python -c "from acido.utils.functions import chunks, split_file"
        python -c "from acido.utils.shell_utils import wait_command, exec_command"

    - name: Test CLI help
      run: |
        python -m acido.cli --help
        python -m acido.cli create --help

    - name: Run Python syntax check
      run: |
        python -m py_compile acido/cli.py
        python -m py_compile acido/azure_utils/*.py
        python -m py_compile acido/utils/*.py

    - name: Run unit tests
      run: |
        python -m unittest discover -s tests -p "test_*.py" -v

  build-test:
    name: Build and Install Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Build distribution
      run: |
        python -m pip install --upgrade pip setuptools wheel build
        python -m build

    - name: Install from wheel
      run: |
        pip install dist/*.whl

    - name: Verify installation
      run: |
        python -c "from acido.utils.decoration import __version__; print('Successfully installed acido version:', __version__)"
        python -m acido.cli --help

  acido-create-test:
    name: Test Supported Security Tools
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install acido
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install .

    - name: Test acido create from GitHub repository
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        INSTANCE_NAME: test-acido-instance
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        IMAGE_REGISTRY_SERVER: ${{ secrets.IMAGE_REGISTRY_SERVER }}
        IMAGE_REGISTRY_USERNAME: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
        IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
        STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
        STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
        MANAGED_IDENTITY_ID: ${{ secrets.MANAGED_IDENTITY_ID }}
        MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
      run: |
        # Test GitHub URL support - build nuclei image directly from projectdiscovery/nuclei repository
        # This validates the new git+https:// syntax for building images from GitHub
        acido create git+https://github.com/projectdiscovery/nuclei || echo "Note: Image creation may fail without proper credentials, but command should execute"

    - name: E2E Test - Deploy and manage nuclei fleet
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        INSTANCE_NAME: test-acido-instance
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        IMAGE_REGISTRY_SERVER: ${{ secrets.IMAGE_REGISTRY_SERVER }}
        IMAGE_REGISTRY_USERNAME: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
        IMAGE_REGISTRY_PASSWORD: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
        STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
        STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
        MANAGED_IDENTITY_ID: ${{ secrets.MANAGED_IDENTITY_ID }}
        MANAGED_IDENTITY_CLIENT_ID: ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
      run: |
        # Create a target list file
        echo -e "merabytes.com\nuber.com\nfacebook.com" > /tmp/targets.txt
        
        # Deploy fleet in background with 30 second timeout
        echo "Deploying nuclei fleet with ci-test name..."
        timeout 30s acido fleet ci-test -n 3 -im nuclei -t 'nuclei -list input' -i /tmp/targets.txt -o /tmp/ci-test-output || echo "Fleet deployment timed out after 30s (expected)"
        
        # Test list command
        echo "Testing 'acido ls' command..."
        acido ls || echo "List command may fail if no instances exist"
        
        # Test remove command
        echo "Testing 'acido rm ci-test' command..."
        acido rm 'ci-test*' || echo "Remove command completed"
        
        # Verify fleet was cleaned up
        echo "Verifying cleanup..."
        acido ls || echo "Final list check completed"

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint

    - name: Run flake8
      continue-on-error: true
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 acido --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 acido --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Check code structure
      run: |
        # Verify all Python files are valid
        find acido -name "*.py" -exec python -m py_compile {} \;

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t acido-cli:test -f Dockerfile .

    - name: Test acido CLI in Docker
      run: |
        # Test basic help command
        docker run --rm acido-cli:test --help
        
        # Test subcommands help
        docker run --rm acido-cli:test create --help
        docker run --rm acido-cli:test fleet --help
        docker run --rm acido-cli:test run --help
        docker run --rm acido-cli:test ls --help
        docker run --rm acido-cli:test rm --help
        docker run --rm acido-cli:test ip --help
        
        # Test version info
        docker run --rm acido-cli:test --version || echo "Version command test completed"

    - name: Test acido CLI with environment variables
      env:
        AZURE_RESOURCE_GROUP: test-rg
        IMAGE_REGISTRY_SERVER: test.azurecr.io
        IMAGE_REGISTRY_USERNAME: testuser
        IMAGE_REGISTRY_PASSWORD: testpass
        STORAGE_ACCOUNT_NAME: testaccount
      run: |
        # Test that CLI accepts environment variables for configuration
        docker run --rm \
          -e AZURE_RESOURCE_GROUP \
          -e IMAGE_REGISTRY_SERVER \
          -e IMAGE_REGISTRY_USERNAME \
          -e IMAGE_REGISTRY_PASSWORD \
          -e STORAGE_ACCOUNT_NAME \
          acido-cli:test ls || echo "CLI environment variable test completed"
