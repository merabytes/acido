# Acido - Golang Version Makefile

# Variables
BINARY_NAME=acido
VERSION?=$(shell git describe --tags --always --dirty)
LDFLAGS=-ldflags "-s -w -X main.version=${VERSION}"
BUILD_DIR=dist
PLATFORMS=linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64

# Colors for output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m # No Color

.PHONY: all build test lint clean install help

all: test build ## Run tests and build

help: ## Display this help screen
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build: ## Build binary for current platform
	@echo "${GREEN}Building ${BINARY_NAME}...${NC}"
	@go build ${LDFLAGS} -o ${BUILD_DIR}/${BINARY_NAME} ./cmd/acido
	@echo "${GREEN}✓ Build complete: ${BUILD_DIR}/${BINARY_NAME}${NC}"

build-all: clean ## Build binaries for all platforms
	@echo "${GREEN}Building for all platforms...${NC}"
	@mkdir -p ${BUILD_DIR}
	@for platform in ${PLATFORMS}; do \
		IFS='/' read -r GOOS GOARCH <<< "$$platform"; \
		output="${BUILD_DIR}/${BINARY_NAME}-${VERSION}-$$GOOS-$$GOARCH"; \
		if [ "$$GOOS" = "windows" ]; then output="$$output.exe"; fi; \
		echo "Building for $$GOOS/$$GOARCH..."; \
		GOOS=$$GOOS GOARCH=$$GOARCH CGO_ENABLED=0 go build ${LDFLAGS} -o $$output ./cmd/acido; \
	done
	@echo "${GREEN}✓ All builds complete${NC}"

build-lambda: ## Build Lambda handlers
	@echo "${GREEN}Building Lambda handlers...${NC}"
	@mkdir -p ${BUILD_DIR}/lambda
	@GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build ${LDFLAGS} -o ${BUILD_DIR}/lambda/fleet ./lambda/fleet
	@GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build ${LDFLAGS} -o ${BUILD_DIR}/lambda/secrets ./lambda/secrets
	@echo "${GREEN}✓ Lambda builds complete${NC}"

test: ## Run unit tests
	@echo "${GREEN}Running tests...${NC}"
	@go test -v -race -coverprofile=coverage.out ./...
	@echo "${GREEN}✓ Tests passed${NC}"

test-coverage: test ## Run tests with coverage report
	@go tool cover -html=coverage.out -o coverage.html
	@echo "${GREEN}✓ Coverage report generated: coverage.html${NC}"

lint: ## Run linters
	@echo "${GREEN}Running linters...${NC}"
	@if ! command -v golangci-lint &> /dev/null; then \
		echo "${YELLOW}Installing golangci-lint...${NC}"; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
	fi
	@golangci-lint run ./...
	@echo "${GREEN}✓ Linting complete${NC}"

fmt: ## Format code
	@echo "${GREEN}Formatting code...${NC}"
	@go fmt ./...
	@echo "${GREEN}✓ Code formatted${NC}"

vet: ## Run go vet
	@echo "${GREEN}Running go vet...${NC}"
	@go vet ./...
	@echo "${GREEN}✓ Vet complete${NC}"

mod-tidy: ## Tidy go modules
	@echo "${GREEN}Tidying modules...${NC}"
	@go mod tidy
	@echo "${GREEN}✓ Modules tidied${NC}"

install: build ## Install binary to GOPATH/bin
	@echo "${GREEN}Installing ${BINARY_NAME}...${NC}"
	@go install ${LDFLAGS} ./cmd/acido
	@echo "${GREEN}✓ Installed to $(shell go env GOPATH)/bin/${BINARY_NAME}${NC}"

clean: ## Clean build artifacts
	@echo "${YELLOW}Cleaning build artifacts...${NC}"
	@rm -rf ${BUILD_DIR}
	@rm -f coverage.out coverage.html
	@echo "${GREEN}✓ Clean complete${NC}"

docker-lambda: build-lambda ## Build Docker images for Lambda
	@echo "${GREEN}Building Lambda Docker images...${NC}"
	@docker build -f Dockerfile.lambda.fleet -t acido-lambda-fleet:latest .
	@docker build -f Dockerfile.lambda.secrets -t acido-lambda-secrets:latest .
	@echo "${GREEN}✓ Docker images built${NC}"

benchmark: ## Run benchmarks
	@echo "${GREEN}Running benchmarks...${NC}"
	@go test -bench=. -benchmem ./...

integration-test: ## Run integration tests (requires Azure credentials)
	@echo "${GREEN}Running integration tests...${NC}"
	@go test -v -tags=integration ./test/integration/...

pre-commit: fmt vet lint test ## Run all pre-commit checks
	@echo "${GREEN}✓ All pre-commit checks passed${NC}"

release: clean build-all docker-lambda ## Build release artifacts
	@echo "${GREEN}Release artifacts created in ${BUILD_DIR}/${NC}"

# Development helpers
dev-setup: ## Setup development environment
	@echo "${GREEN}Setting up development environment...${NC}"
	@go mod download
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install golang.org/x/tools/gopls@latest
	@echo "${GREEN}✓ Development environment ready${NC}"

run: build ## Build and run acido
	@${BUILD_DIR}/${BINARY_NAME} $(ARGS)

watch: ## Watch for changes and rebuild (requires entr)
	@if ! command -v entr &> /dev/null; then \
		echo "${RED}Error: entr not installed. Install with: brew install entr (macOS) or apt-get install entr (Linux)${NC}"; \
		exit 1; \
	fi
	@find . -name '*.go' | entr -r make run
